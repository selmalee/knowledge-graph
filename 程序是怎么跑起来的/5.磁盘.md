# 5 磁盘
## 5.1 磁盘和内存的关系
内存和磁盘都是存储部件。
 - 内存利用电流来实现存储，高速高价。内存主要指主内存（负责存储CPU中运行的程序指令和数据的内存）。
 - 磁盘利用磁效应来实现存储，低速廉价。磁盘主要指硬盘（机械硬盘）。

磁盘中存储的程序，必须要加载到内存后才能运行。因为，负责运行程序的CPU，需要通过程序计数器来指定内存地址，然后读出程序。而且磁盘读取速度慢，一次性加载到内存后，再运行，能大大提高程序运行速度。
> 程序保存在存储设备中，通过有序地被读出来运行，这一机制称为 __存储程序方式__。

## 5.2 磁盘缓存
__磁盘缓存__ （disk cache）指把磁盘读出的数据存储到内存空间中的方式。这样，当接下来需要读取同一个数据时，直接从磁盘缓存（内存的一部分）中读取即可，大大提升访问速度。但随着硬盘访问速度的大幅改善，磁盘缓存的效果没有之前明显了。
把低速设备的数据保存在高速设备中，需要时直接从告诉设备中读出，这种 __缓存__ 的方式在其他地方也有使用。比如web浏览器中，把低速的网络数据保存到相对高速的磁盘中。

## 5.3 虚拟内存
__虚拟内存__ 是指把磁盘的一部分作为假想的内存（实际上是磁盘）来使用，这与 __磁盘缓存__ 的概念（实际上是内存）相对。通过借助虚拟内存，在内存不足时也可以运行程序。
### 5.3.1 具体实现
CPU只能执行加载到内存中的程序，虚拟内存虽说是磁盘的一部分，但实际上正在运行的程序部分，是在内存中的。即，实际内存的内容，和磁盘上的虚拟内存的内容进行部分置换，并同时运行程序。虚拟内存的方法分为 __分页式__ 和 __分段式__ 两种。
Windows采用的是分页式，以页为单位在内存和磁盘间进行置换（page in和page out）。Windows在磁盘上提供了虚拟内存用的文件（页文件），文件的大小就是虚拟内存的大小

### 5.4 良好的编程方法可以节约内存
虽然虚拟内存可以避免内存不足而导致无法运行程序的问题，但是使用虚拟内存时发生的page in和page out中有低速的磁盘访问，应用的运行会变慢。虚拟内存无法完全解决内存不足的问题。
所以，尽量把运行的应用文件变小，以及在编程中注意：
 - 通过DLL文件实现函数共有。DLL（Dynamic Link Library），在程序运行时动态加载Library（函数和数据的集合）。多个文件共用一个DLL文件可以节约内存。
 - 通过调用`_stdcall`减小程序文件大小。C语言中，在调用函数后，需要执行栈清理，即从接受和传递函数的参数时使用的内存上的栈区域中清理不需要的数据。如果是同样的函数，栈清理处理的内容是一样的。在函数前加上`_stdcall`，就可以把栈清理处理变为在被调用函数内进行，同一个函数的栈清理的程序在文件里就只会有一次。

### 5.5 磁盘的物理结构
磁盘是通过把其物理表面划分成多个空间来使用的。划分的方式有 __扇区方式__ 和 __可变长方式__ 两种。
 - 扇区方式：把磁盘划分成固定长度的空间。
 - 可变长方式：把磁盘划分成长度可变的空间。

一般的Windows计算机采用的就是这个方式。把磁盘分成若干个同心圆的空间就是 __磁道__，磁道按固定大小划分而成的空间就是 __扇区__。扇区是物理读写的最小单位。在逻辑方面，对磁盘进行读写的单位是扇区整数倍 __簇__。即，所有的文件都会占用1簇的整数倍的磁盘空间，不同文件不能存储在同一个簇里。
扇区和簇的大小，是由处理速度和存储容量的平衡来决定的。簇的容量过大，会造成空间浪费；簇的容量越小，同样的文件，磁盘访问次数越多，读写时间会增加。

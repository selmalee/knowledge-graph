# 1 CPU

程序是什么？程序是指令和数据的组合体。

CPU是什么？CPU是负责程序的解释和运行，并控制整个计算机的设备的计算机的构成元件。

运行程序的步骤：

1. 程序员用C语音等高级语言编写程序
2. 将程序编译后转换成机器语言的exe文件
3. 程序运行时，在内存中生成exe文件的副本
4. CPU解释并执行程序内容

> CPU能直接识别和执行的只有机器语言。使用C、Java等语言编写的程序，最后都会转化成机器语言。
>
> 硬盘和磁盘等媒介保存的程序被复制到内存后才能运行。
>
> CPU中，根据程序的指令来进行数据运算，并控制整个计算机的设备。



## 1.1 CPU的内部结构解析

CPU的内部由寄存器、控制器、运算器和时钟四个部分构成。

- 寄存器：用来暂存指令、数据等处理对象，可以看作是内存的一种。

  > 内存指的是计算机的主存储器，简称主存。 详细见第4章

- 控制器：负责把内存上的指令、数据等读入寄存器，并根据指令的执行结果来控制整个计算机。

- 运算器：负责运算从内存读入寄存器的数据。

- 时钟：负责发出CPU开始计时的时钟信号。时钟信号的频率单位是GHz（1GHz=10亿次/秒），频率越高，CPU的运行速度越快。



## 1.2 各种寄存器

CPU是寄存器的集合体

- 程序计数器：存储下一条指令所在内存的地址。
- 标志寄存器：存储运算处理后的CPU状态
- 累加寄存器：存储执行运算的数据和运算后的数据
- 基址寄存器：存储数据内存的起始地址
- 变址寄存器：存储基址寄存器的相对地址
- 通用寄存器：存储任意数据

>  我们常说的64位处理器是采用64位处理技术的CPU，相比较32位的CPU来说，64位CPU最为明显的变化就是增加了8个64位的[通用寄存器](https://baike.baidu.com/item/通用寄存器/283978)，[内存寻址](https://baike.baidu.com/item/内存寻址)能力提高到64位（地址引脚64个），以及寄存器和指令指针升级到64位等。



## 1.3 程序计数器决定程序的流程

例如，0100是程序运行的开始位置，操作系统把程序从硬盘复制到内存后，会将程序计数器设定为0100，然后程序开始执行。CPU每执行一个指令，程序计数器就会自动加1。CPU的控制器就会参照__程序计数器__的数值，从内存中读取命令并执行。



## 1.4 条件分支和循环机制

程序的流程分为顺序执行、条件分支和循环。

- 顺序执行：如2.1所述，每执行一个指令，程序计数器就会自动加1。
- 条件分支和循环：机器语言的__跳转指令__将程序计数器的值设定为任意地址，这样程序就可以跳转到任意地址或返回到之前的地址重复执行一个指令。

条件分支和循环中使用的__跳转指令__，会参考__标志寄存器__的数值来判断是否跳转。比如执行比较`x>y`的指令，CPU的__累加寄存器__会进行`x-y`的减法运算，结果保存在标志寄存器中。运算结果的正、负、0由标志寄存器的3个位表示。



## 1.5 函数的调用机制

函数的调用需要在完成函数内部的处理后，返回到函数调用指令的下一个地址。机器语言的`call`指令和`return`指令解决这个问题。

- `call`：正将函数的入口地址设定到程序计数器之前，`call`指令会把函数调用指令的下一个地址存储在名为栈的主存內。
- `return`：函数处理完后，再通过函数的出口来执行`return`命令。`return`命令就是把保存在栈中的地址设定到__程序计数器__中。



## 1.6 实现数组

通过__基址寄存器__和__变址寄存器__，可以对主内存中的特定区域划分，从而实现类似于数组的操作。

例如，查看10000000地址～1000FFFF地址时，可以将10000000存入__基址寄存器__，并使__变址寄存器__的值在00000000～0000FFFF变化。__变址寄存器__的值就相当于高级程序语言程序中数组的索引功能。



## 1.7 机器语言指令

机器语言指令的主要类型：

- 数据转送指令：寄存器和内存、内存和内存、寄存器和外围设备之间的数据读写操作。
- 运算指令：用累加寄存器执行算术运算、逻辑运算等运算。
- 跳转指令：实现条件分支、循环、强制跳转等。
- call/return指令：实现函数的调用/返回调用前的地址。

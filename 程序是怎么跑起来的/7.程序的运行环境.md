# 7 程序的运行环境
## 7.1 运行环境 = 操作系统 + 硬件
如Office2007的运行环境是500MHZ以上的CPU（硬件）和Windows Server 2003 PS1及以上版本的操作系统。
同一类型的硬件可以选择安装多种操作系统。如AT兼容机中，可以按照Windows，也可以按照Linux等操作系统。
从程序的运行环境来考量硬件时，CPU的种类是特别重要的参数。因为CPU只能解释固有的机器语言，不同的CPU（x86、MIPS、SPARC等）能解释的机器语言的种类是不同的。市面上出售的用于Windows的应用软件包CD-ROM中，不是源代码而是本地代码。
 > 机器语言的程序称为本地代码（native code）。

## 7.2 Windows克服了CPU以外的硬件差异
在20年前的MS-DOS时代，市场上有NEC的PC-9801、东芝的Dynabook等。Windows3.0问世前后，AT兼容机开始普及，与PC-9801争夺市场份额。这些机型虽然都有bentiunm等x86系列的CPU，但是他们的内存和I/O地址的构成等都是不同的。
 > MS-DOS是20世纪80年代普遍使用的操作系统。
 > AT兼容机，即IBM PC兼容机（英语：IBM PC compatible），是指与IBM的PC机兼容的个人电脑。早期的IBM兼容机主要是基于x86系列CPU，使用ISA总线，能够运行PC-DOS／MS-DOS系统。
因为MS-DOS的功能不完善，而且为了提高程序的运行速度，MS-DOS应用大多都是不经过操作系统直接控制硬件的。所以每种机型都需要有专门的MS-DOS应用。
Windows则克服了CPU以外的硬件差异。在Windows的应用软件中，键盘输入、显示器输出等不是直接操作硬件，而是通过向Windows发送指令来间接实现的。这样，应用软件开发的程序员就不用注意内存和I/O地址的不同构成了。

## 7.3 不同操作系统的API不同
除了Windows外，还有Unix系列的操作系统。这些操作系统的API是有差异的。所以针对不同的操作系统，同样的应用程序需要重写应用中利用的API的部分。
 > API：应用程序向操作系统传递指令的途径。
但这些操作系统不能克服CPU的硬件差异。由于CPU不同，机器语言也不同，所以需要能够将源代码生成各CPU专用的本地代码的编译器。

## 7.4 FreeBSD Port
Unix系列操作系统FreeBSD中，存在一种Ports的机制。该机制能够结合当前运行的硬件环境来编译应用的源代码，从而得到可以运行的本地代码系统。如果源代码没有在硬件上的话，Ports会使用FTP连接到相关站点来下载代码。
 > 文件传输协议（英语：File Transfer Protocol，缩写：FTP）是一个用于在计算机网络上在客户端和服务器之间进行文件传输的应用层协议。

## 7.5 利用虚拟机获得其他操作系统环境
利用虚拟机软件，比如Virtual PC for MAC，可以使Macinotosh变得像AT兼容机一样，从而能在Macinotosh上安装Windows。

## 7.6 提供相同运行环境的Java虚拟机
Java同其他编译语言一样，需要将源代码编译后运行。但Java编译后生成的不是本地代码，而是 __字节代码__。字节代码的运行环境就称为 __Java虚拟机__（JavaVM）。Java虚拟机是一边把Java字节代码逐一转换成本地代码，一边运行的。比如，AT兼容机中，Java编译器先将源代码（sample.java）转换成字节代码（sample.class）。而Java虚拟机（java.exe）则会把字节代码变换成x86系列CPU使用的本地代码，然后由CPU负责运行。这样，同样的字节代码的应用就可以在任何环境下运行了。
在操作系统方面来看，Java虚拟机是一个应用。Windows有Windows的Java虚拟机，MacOS有MacOS的Java虚拟机。
缺点：不同的Java虚拟机之间无法完整互换；运行速度慢，每次运行都要把字节代码变换成本机代码。

 > 在现在JavaScript引擎中，大致的执行过程是：
 > 编译器将源代码编译成抽象语法树，再将抽象语法树编译成字节码；解释器来接收字节码，解释执行这些字节码；JIT工具，分析这些字节码并将其中的部分字节码转换成本地代码。
 > 这个过程和Java的编译和执行过程很像，只是Java语言中这两个阶段是分开执行的，编译阶段可以尽可能的生成高效的字节码，这样在执行阶段可以执行的更快。而对于Javascript而言，它的编译阶段是在网页和JavaScript文件下载后同执行阶段一起在网页的加载和渲染过程中来实施的，所以对于JavaScript引擎执行过程中的每个阶段时间越少越好。
 > ![](https://image-static.segmentfault.com/352/972/3529727489-5abe0e6502f40_fix732)
 > 详细看[javascript引擎工作原理的初步了解](https://segmentfault.com/a/1190000014242281)

## 7.7 BIOS和引导
BIOS存储在ROM中，是预先内置在计算机主机内部的程序，包括键盘、磁盘、显卡等基本控制程序，和启动“引导程序”的功能。引导程序是存储在启动驱动器起始区域的小程序。
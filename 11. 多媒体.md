# 直播

 ## 1 拉流协议对比

[视频云直播中的关键帧（I帧）技术探秘](https://www.dnsdizhi.com/224.html)

- RTMP：其原理是将大块的视频帧和音频帧“剁碎”，然后以小数据包的形式进行传输，且支持加密，因此隐私性相对比较理想，但由于拆包组包的过程较复杂，所以在海量并发时也容易出现一些不可预期的稳定性问题。
- HLS：苹果推出的流媒体协议，将视频分成5-10秒的视频小分片，然后用m3u8索引表进行管理，由于客户端下载到的视频都是5-10秒的完整数据，故视频的流畅性很好。但一般播放器会在缓存3-4个分片后才启动播放，因此也引入了10-30s左右的延时。
- HTTP-FLV：由Adobe公司主推，格式极其简单，只是在大块的视频帧和音视频头部加入一些标记头信息，在延迟表现和大规模并发方面都很成熟。但需要注意的是HTTP-FLV在手机浏览器上的支持非常有限。



# 2 直播延迟优化

[使用flv.js做直播](https://github.com/gwuhaolin/blog/issues/3)

优化推流端

- h264编码一定不要开启B帧， 解码时B 帧依赖于前后的帧，会增加延迟。
- h264 编码使用 H.264 baseline profile，减少编码时消耗的时间。
- 音频尽量使用AAC-LC Codec，这样会减少编码时消耗的时间。
- 适当调整关键帧间隔（GOP大小）。减少GOP帧的数量，能减少播放器加载GOP帧所用的时间。在直播推流端GOP一般建议设置为1~2s。当用户第一次观看的时候，播放器需要找到I帧才能开始播放，而播放器会到服务器寻找到最近的I帧反馈给用户。

优化播放器端

- 播放端的优化因播放器而定，这里以flv.js播放器为例，图中stashInitialSize的值就是播放器缓存大小，可按需调整。
- 选择HTTP-FLV作为播放协议能有效地降低时延。但HLS对浏览器兼容比较友好，且支持跨终端，所以HLS也是很多用户的首选。



# 点播

 [为什么视频网站的视频链接地址是blob？](https://juejin.im/post/5d1ea7a8e51d454fd8057bea )

## 1.1 Blob 是什么

 最早是数据库直接用Blob来存储二进制数据对象，这样就不用关注存储数据的格式了。在web领域，Blob对象表示一个只读原始数据的类文件对象，虽然是二进制原始数据但是类似文件的对象，因此可以像操作文件对象一样操作Blob对象。 

``` js
const objectURL = URL.createObjectURL(object); //blob:http://localhost:1234/abcedfgh-1234-1234-1234-abcdefghijkl
```

 这里的object参数是用于创建URL的File对象、Blob 对象或者 MediaSource 对象，生成的链接就是以blob:开头的一段地址，表示指向的是一个二进制数据。 

可以用于防爬虫

## 1.2 HLS和MPEG DASH

 HLS （HTTP Live Streaming）, 是由 Apple 公司实现的基于 HTTP 的媒体流传输协议。 

DASH（Dynamic Adaptive Streaming over HTTP） ，是一种在互联网上传送动态码率的Video Streaming技术，类似于苹果的HLS，DASH会通过media presentation description (MPD)将视频内容切片成一个很短的文件片段，每个切片都有多个不同的码率，DASH Client可以根据网络的情况选择一个码率进行播放，支持在不同码率之间无缝切换。

### 1.2.1 与mp4对比

| 视频格式 | 播放体验                                                     | 流量占用情况                                                 |
| -------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| DASH     | 对视频进行切片，按切片播放，缓存小起播快；拖动时间轴到任意时间播放时，可以快速定位到对应的切片进行播放，响应快。 | 小。                                                         |
| HLS      | 对视频进行切片，按切片播放，缓存小起播快；拖动时间轴到任意时间播放时，可以快速定位到对应的切片进行播放，响应快。 | 整体占用小，播放一个切片只下载一个切片内容；对于低码率的视频场景，因封装代价高导致流量占用相对较高。 |
| MP4      | 头文件较大，边下边缓存，起播相对HLS和DASH慢一些；拖动时间轴播放时，需要一定的时间缓存；市场上大多数的浏览器客户端均能够播放，播放成功率高。 | 拖动时间轴播放时，仍然需要下载整个头文件，耗费流量大；因流量占用较大，建议用在短视频处理的场景。 |

## 1.3 利用`MediaSource`实现续点续传

基本流程就是通过`URL.createObjectURL`创建容器的BLob URL，设置到`video`标签的`src`上，在播放过程中，我们请求视频数据，通过`MediaSource.appendBuffer`方法往容器里添加数据，达到更新视频内容的目的。 

